<!doctype html><html lang=en>
<head>
<title>[NOTE] Developing eBPF profiler for polyglot cloud-native applications :: xujiajiadexiaokeai</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="[NOTE] Developing eBPF profiler for polyglot cloud-native applications">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://xujiajiadexiaokeai.github.io/2023-04-09/developing-ebpf-profiler-for-polyglot-cloud-native-applications/>
<link rel=stylesheet href=https://xujiajiadexiaokeai.github.io/assets/style.css>
<link rel=apple-touch-icon href=https://xujiajiadexiaokeai.github.io/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://xujiajiadexiaokeai.github.io/favicon.ico>
<meta name=twitter:card content="summary">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="[NOTE] Developing eBPF profiler for polyglot cloud-native applications">
<meta property="og:description" content="[NOTE] Developing eBPF profiler for polyglot cloud-native applications">
<meta property="og:url" content="https://xujiajiadexiaokeai.github.io/2023-04-09/developing-ebpf-profiler-for-polyglot-cloud-native-applications/">
<meta property="og:site_name" content="xujiajiadexiaokeai">
<meta property="og:image" content="https://xujiajiadexiaokeai.github.io/favicon.ico">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2023-04-09 14:15:30 +0800 +0800">
</head>
<body class=orange>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
RTSC && RTFM
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://xujiajiadexiaokeai.github.io/2023-04-09/developing-ebpf-profiler-for-polyglot-cloud-native-applications/>[NOTE] Developing eBPF profiler for polyglot cloud-native applications</a></h1>
<div class=post-meta>
<span class=post-date>
2023-04-09
</span>
<span class=post-author>:: Wenhao Jiang</span>
<span class=post-reading-time>:: 3 min read (551 words)</span>
</div>
<span class=post-tags>
#<a href=https://xujiajiadexiaokeai.github.io/tags/profiling/>Profiling</a>&nbsp;
#<a href=https://xujiajiadexiaokeai.github.io/tags/observability/>Observability</a>&nbsp;
#<a href=https://xujiajiadexiaokeai.github.io/tags/ebpf/>eBPF</a>&nbsp;
</span>
<div class=post-content><div>
<h1 id=note-developing-ebpf-profiler-for-polyglot-cloud-native-applications>[NOTE] Developing eBPF profiler for polyglot cloud-native applications<a href=#note-developing-ebpf-profiler-for-polyglot-cloud-native-applications class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<h2 id=agenda>Agenda<a href=#agenda class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<ul>
<li>Infrastructure-wide profilers</li>
<li>Low level ecosystem</li>
<li>Stack unwinding/walking in the Linux Kernel</li>
<li>Building profilers using BPF</li>
<li>Walking user stacks(without frame pointers)</li>
<li>Future work</li>
</ul>
<h2 id=profilers-for-the-cloud-native-environment>Profilers for the cloud native environment<a href=#profilers-for-the-cloud-native-environment class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>Discovery mechanism for the targets</p>
<p>-> Mechanism to collect stack traces(kernel, userspace)</p>
<p>-> Profile formats</p>
<p>-> Async symbolization & visualization</p>
<h2 id=low-level-ecosystem>Low level ecosystem<a href=#low-level-ecosystem class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h3 id=elf-and-dwarf>ELF and DWARF<a href=#elf-and-dwarf class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>Executable Linkable format -ELF
<ul>
<li>for obj file, executable program, shared object etc</li>
</ul>
</li>
<li>DWARF - widely used debugging format
<ul>
<li>CIE - Common information Entry</li>
</ul>
</li>
<li>Tools to read ELF and/or DWARF information
<ul>
<li>readily, objdump, elfutils, llvm-dwarfdump</li>
<li>gcc also has -g option</li>
</ul>
</li>
</ul>
<h3 id=stacktraces-and-x86_64-abi>Stacktraces and x86_64 ABI<a href=#stacktraces-and-x86_64-abi class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>What collection stack traces involve
<ul>
<li>Kernel stacks</li>
<li>Application stacks</li>
</ul>
</li>
<li>Direction of stack growth</li>
<li>So what are stack pointers, where do they come form</li>
</ul>
<h3 id=rbp-rsp--rip-registers>$rbp, $rsp & $rip registers<a href=#rbp-rsp--rip-registers class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>$rbp: address of the base of the previous stack frame</li>
<li>$rsp: Top of the stack, local variables
<ul>
<li>Generally previous value of rsp is where FP is stored</li>
</ul>
</li>
<li>$rip: Holds the pc for the currently executing function</li>
</ul>
<h3 id=frame-pointers-are-often-disabled>Frame pointers are often disabled<a href=#frame-pointers-are-often-disabled class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>Increased binary size -> less i-cache hits</li>
<li>1 less rigister available</li>
</ul>
<h3 id=cons-of-disabling-frame-pointers>Cons of disabling frame pointers<a href=#cons-of-disabling-frame-pointers class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>Walking stack traces becomes more expensive</li>
<li>Less accuracy</li>
<li>Way more work ofr compiler / debugger / profiler developers</li>
<li>This information is large</li>
</ul>
<h3 id=the-reality>The reality<a href=#the-reality class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<h3 id=frame-pointer-believers>Frame pointer believers<a href=#frame-pointer-believers class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>Golang >= 1.7</li>
<li>MacOS</li>
<li>The Linux Kernel(*):
<ul>
<li>CONFIG_UNWINDER_FRAME_POINTER and CONFIG_UNWINDER_ORC</li>
</ul>
</li>
</ul>
<h3 id=stack-unwinding-in-the-linux-kernel-wo-fp>Stack unwinding in the Linux kernel w/o fp<a href=#stack-unwinding-in-the-linux-kernel-wo-fp class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>ORC (CONFIG_UNWINDER_ORC x86_64 only)</li>
<li>Doesn&rsquo;t rely on .debug_frame/.eh_frame</li>
<li>Enabled by some of the major cloud vendors</li>
</ul>
<h3 id=unwinding-the-stack-without-frame-pointers>Unwinding the stack without frame pointers<a href=#unwinding-the-stack-without-frame-pointers class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>DWARF unwind information
<ul>
<li>.eh_frame</li>
<li>.debug_frame</li>
</ul>
</li>
<li>Synthesizing them from object code</li>
<li>Guessing which stack vlues are return addresses</li>
</ul>
<h3 id=eh_frame---unwind-tables>.eh_frame - unwind tables<a href=#eh_frame---unwind-tables class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ readelf -wF ./test_binary
</code></pre></div><table>
<thead>
<tr>
<th style=text-align:center>LOC</th>
<th style=text-align:center>CFA</th>
<th style=text-align:center>rbp</th>
<th style=text-align:center>ra</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>00000000004011f0</td>
<td style=text-align:center>rsp+8</td>
<td style=text-align:center>u</td>
<td style=text-align:center>c-8</td>
</tr>
<tr>
<td style=text-align:center>00000000004011f1</td>
<td style=text-align:center>rsp+16</td>
<td style=text-align:center>c-16</td>
<td style=text-align:center>c-8</td>
</tr>
<tr>
<td style=text-align:center>00000000004011f4</td>
<td style=text-align:center>rbp+16</td>
<td style=text-align:center>c-16</td>
<td style=text-align:center>c-8</td>
</tr>
<tr>
<td style=text-align:center>0000000000401242</td>
<td style=text-align:center>rsp+8</td>
<td style=text-align:center>c-16</td>
<td style=text-align:center>c-8</td>
</tr>
</tbody>
</table>
<h3 id=eh_frame---generating-unwind-tables>.eh_frame - generating unwind tables<a href=#eh_frame---generating-unwind-tables class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ readelf --debug-dump<span style=color:#f92672>=</span>frames ./test_binary
</code></pre></div><h2 id=stack-unwinding-with-ebpf>Stack unwinding with eBPF<a href=#stack-unwinding-with-ebpf class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h3 id=with-frame-pointers>With frame pointers<a href=#with-frame-pointers class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<pre tabindex=0><code>user_stack = map&lt;stack_id, array&lt;addresses&gt;&gt;
add_stack bumps map&lt;stack_id, count_t&gt;
stack_id = bpd_get_stackid(ctx, &amp;user_stacks, BPF_F_USER_STACK);
add_stack(stack_id);
</code></pre><h3 id=without-frame-pointers>Without frame pointers<a href=#without-frame-pointers class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>BPF code: ~250 lines of C</li>
<li>DWARF unwind info parser and evaluator: >1k lines of Go</li>
</ul>
<h3 id=unwinding-wo-frame-pointers---architecture>Unwinding w/o frame pointers - architecture<a href=#unwinding-wo-frame-pointers---architecture class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<pre tabindex=0><code>struct unwind_row {
	u64 program_counter;
	type_t previous_rsp;
	type_t previous_rbp;
}
</code></pre><h3 id=unwinding-wo-frame-pointers---unwind-table-gen>Unwinding w/o frame pointers - unwind table gen<a href=#unwinding-wo-frame-pointers---unwind-table-gen class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>.eh_frame / .debug_frame
<ul>
<li>Parse</li>
<li>Evaluate</li>
</ul>
</li>
</ul>
<h3 id=unwinding-wo-frame-pointers---bpf>Unwinding w/o frame pointers - BPF<a href=#unwinding-wo-frame-pointers---bpf class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>Find the unwind table for the current process</li>
<li>While main isn&rsquo;t reached:
<ul>
<li>Append the program counter ($rip) to the walked stack</li>
<li>Find the unwind row for the current program counter</li>
<li>Restore registers for the provious frame
<ul>
<li>Return address $rip</li>
<li>Stack pointer $rsp</li>
<li>And $rbp, too</li>
</ul>
</li>
</ul>
</li>
<li>Efficiently finding the unwind data for a program counter</li>
<li>Fun to implement in BPF</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>find_offset_for_pc</span>(__u32 index, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>data) {
	<span style=color:#66d9ef>struct</span> callback_ctx <span style=color:#f92672>*</span>ctx <span style=color:#f92672>=</span> data;
	
	<span style=color:#66d9ef>if</span> (ctx<span style=color:#f92672>-&gt;</span>left <span style=color:#f92672>&gt;=</span> ctx<span style=color:#f92672>-&gt;</span>right) {
		LOG(<span style=color:#e6db74>&#34;.done&#34;</span>);
		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
	}
	
	u32 mid <span style=color:#f92672>=</span> (ctx<span style=color:#f92672>-&gt;</span>left <span style=color:#f92672>+</span> ctx<span style=color:#f92672>-&gt;</span>right) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>;
	
	<span style=color:#75715e>// Appease the verifier.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (mid <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> mid <span style=color:#f92672>&lt;=</span> MAX_UNWIND_TABLE_SIZE) {
		LOG(<span style=color:#e6db74>&#34;.should never happen&#34;</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
	}
	
	<span style=color:#66d9ef>if</span> (ctx<span style=color:#f92672>-&gt;</span>table<span style=color:#f92672>-</span>rows[mid].pc <span style=color:#f92672>&lt;=</span> ctx<span style=color:#f92672>-&gt;</span>pc) {
		ctx<span style=color:#f92672>-&gt;</span>found <span style=color:#f92672>=</span> mid;
		ctx<span style=color:#f92672>-&gt;</span>left <span style=color:#f92672>=</span> mid <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
	} <span style=color:#66d9ef>else</span> {
		ctx<span style=color:#f92672>-&gt;</span>right <span style=color:#f92672>=</span> mid;
	}
	
	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><h3 id=unwinding-wo-frame-pointers---future-work>Unwinding w/o frame pointers - Future work<a href=#unwinding-wo-frame-pointers---future-work class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>Testing more complex binaries</li>
<li>arm64 support</li>
<li>Static table size</li>
<li>But we know we will hit limits</li>
<li>Reduce minimum required kernel version</li>
<li>Engage with various communities</li>
</ul>
<h1 id=sources>Sources<a href=#sources class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<ul>
<li><a href="https://www.youtube.com/watch?v=Gr1rrSzvqfg">https://www.youtube.com/watch?v=Gr1rrSzvqfg</a></li>
</ul>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://xujiajiadexiaokeai.github.io/2022-09-20/summary/>
<span class=button__icon>←</span>
<span class=button__text>关于离职后的这一年我做了什么</span>
</a>
</span>
<span class="button next">
<a href=https://xujiajiadexiaokeai.github.io/2023-04-08/parca/>
<span class=button__text>Parca</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>© 2021-2023 xujiajiadexiaokeai</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://xujiajiadexiaokeai.github.io/assets/main.js></script>
<script src=https://xujiajiadexiaokeai.github.io/assets/prism.js></script>
<script src=https://xujiajiadexiaokeai.github.io/assets/displayInlineEquations.js></script>
</div>
</body>
</html>