<!doctype html><html lang=en>
<head>
<title>Go Generic :: xujiajiadexiaokeai</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Go Generic">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://xujiajiadexiaokeai.github.io/2022-10-01/go-goroutine/>
<link rel=stylesheet href=https://xujiajiadexiaokeai.github.io/assets/style.css>
<link rel=apple-touch-icon href=https://xujiajiadexiaokeai.github.io/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://xujiajiadexiaokeai.github.io/favicon.ico>
<meta name=twitter:card content="summary">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Go Generic">
<meta property="og:description" content="Go Generic">
<meta property="og:url" content="https://xujiajiadexiaokeai.github.io/2022-10-01/go-goroutine/">
<meta property="og:site_name" content="xujiajiadexiaokeai">
<meta property="og:image" content="https://xujiajiadexiaokeai.github.io/favicon.ico">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2022-10-01 15:16:17 +0800 +0800">
</head>
<body class=orange>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
RTSC && RTFM
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://xujiajiadexiaokeai.github.io/2022-10-01/go-goroutine/>Go Generic</a></h1>
<div class=post-meta>
<span class=post-date>
2022-10-01
</span>
<span class=post-author>:: Wenhao Jiang</span>
<span class=post-reading-time>:: 2 min read (353 words)</span>
</div>
<span class=post-tags>
#<a href=https://xujiajiadexiaokeai.github.io/tags/go/>Go</a>&nbsp;
</span>
<div class=table-of-contents>
<h2>
Table of Contents
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#类型内存布局>类型内存布局</a></li>
<li><a href=#类型检查>类型检查</a></li>
<li><a href=#非泛型突破类型的限制>非泛型突破类型的限制</a>
<ul>
<li><a href=#手工复制>手工复制</a></li>
<li><a href=#代码生成>代码生成</a></li>
<li><a href=#类型断言>类型断言</a></li>
<li><a href=#反射>反射</a></li>
<li><a href=#接口>接口</a></li>
</ul>
</li>
</ul>
<ul>
<li><a href=#类型擦除>类型擦除</a></li>
<li><a href=#虚函数表>虚函数表</a></li>
<li><a href=#字典>字典</a></li>
<li><a href=#单态化>单态化</a></li>
<li><a href=#模版>模版</a></li>
<li><a href=#蜡印>蜡印</a></li>
</ul>
</nav>
</div>
<div class=post-content><div>
<h1 id=什么是泛型>什么是泛型<a href=#什么是泛型 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<h1 id=类型系统>类型系统<a href=#类型系统 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<h2 id=类型内存布局>类型内存布局<a href=#类型内存布局 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h2 id=类型检查>类型检查<a href=#类型检查 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<ul>
<li>强类型、弱类型</li>
<li>静态检查、动态检查</li>
</ul>
<p>静态检查: 编译阶段
动态检查: 运行时阶段
Go的类型检查发生在编译阶段</p>
<ul>
<li>类型推导</li>
</ul>
<p>编译器来做类型推导</p>
<h2 id=非泛型突破类型的限制>非泛型突破类型的限制<a href=#非泛型突破类型的限制 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h3 id=手工复制>手工复制<a href=#手工复制 class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<h3 id=代码生成>代码生成<a href=#代码生成 class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p><a href=https://github.com/cheekybits/genny>genny</a></p>
<ul>
<li>需要一些集成的手段去使用这些库，可能让代码构建变的更复杂。</li>
<li>增加了编译时间。</li>
<li>增加了二进制包的体积。</li>
</ul>
<h3 id=类型断言>类型断言<a href=#类型断言 class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>通过将函数中的参数类型转换为根类型(interface{}),然后对根类型进行期望的类型断言</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// source: https://github.com/danielfurman/presentations/blob/master/lets-go-generic/max.go
</span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;errors&#34;</span>
	<span style=color:#e6db74>&#34;fmt&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MaxNumber</span>(<span style=color:#a6e22e>s</span> []<span style=color:#66d9ef>interface</span>{}) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) { <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>s</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;no values given&#34;</span>)
	}
	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>first</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>[<span style=color:#ae81ff>0</span>].(<span style=color:#66d9ef>type</span>) { <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>int</span>: <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>max</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>first</span>
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>rawV</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>[<span style=color:#ae81ff>1</span>:] {
			<span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rawV</span>.(<span style=color:#66d9ef>int</span>) <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> &gt; <span style=color:#a6e22e>max</span> {
				<span style=color:#a6e22e>max</span> = <span style=color:#a6e22e>v</span>
			}
		}
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>max</span>, <span style=color:#66d9ef>nil</span>
	<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>float64</span>: <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>max</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>first</span>
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>rawV</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>[<span style=color:#ae81ff>1</span>:] {
			<span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rawV</span>.(<span style=color:#66d9ef>float64</span>) <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> &gt; <span style=color:#a6e22e>max</span> {
				<span style=color:#a6e22e>max</span> = <span style=color:#a6e22e>v</span>
			}
		}
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>max</span>, <span style=color:#66d9ef>nil</span>
	<span style=color:#66d9ef>default</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unsupported element type of given slice: %T&#34;</span>, <span style=color:#a6e22e>first</span>)
	}
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>m1</span>, <span style=color:#a6e22e>err1</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MaxNumber</span>([]<span style=color:#66d9ef>interface</span>{}{<span style=color:#ae81ff>4</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>15</span>})       <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>m2</span>, <span style=color:#a6e22e>err2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MaxNumber</span>([]<span style=color:#66d9ef>interface</span>{}{<span style=color:#ae81ff>4.1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>8.1</span>, <span style=color:#ae81ff>15.1</span>}) <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err1</span>, <span style=color:#a6e22e>err2</span>)                               <span style=color:#75715e>// &lt;nil&gt; &lt;nil&gt;
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>m1</span>, <span style=color:#a6e22e>m2</span>)                                   <span style=color:#75715e>// 15 15.1
</span><span style=color:#75715e></span>}
</code></pre></div><ul>
<li>调用方需要将参数包装或转换成根类型。</li>
<li>实现方代码中耦合了大量的类型断言代码。</li>
<li>失去了编译器的类型安全保障。</li>
</ul>
<h3 id=反射>反射<a href=#反射 class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>用反射的技术在运行时获取类型信息,通过对类型的枚举判断来实现</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// source: https://github.com/danielfurman/presentations/blob/master/lets-go-generic/max.go
</span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;errors&#34;</span>
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;reflect&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MaxNumber</span>(<span style=color:#a6e22e>s</span> []<span style=color:#66d9ef>interface</span>{}) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) { <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>s</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;no values given&#34;</span>)
	}

	<span style=color:#a6e22e>first</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>s</span>[<span style=color:#ae81ff>0</span>])
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>first</span>.<span style=color:#a6e22e>CanInt</span>() {
		<span style=color:#a6e22e>max</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>first</span>.<span style=color:#a6e22e>Int</span>()
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ifV</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>[<span style=color:#ae81ff>1</span>:] {
			<span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>ifV</span>)
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>CanInt</span>() {
				<span style=color:#a6e22e>intV</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Int</span>()
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>intV</span> &gt; <span style=color:#a6e22e>max</span> {
					<span style=color:#a6e22e>max</span> = <span style=color:#a6e22e>intV</span>
				}
			}
		}
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>max</span>, <span style=color:#66d9ef>nil</span>
	}

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>first</span>.<span style=color:#a6e22e>CanFloat</span>() {
		<span style=color:#a6e22e>max</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>first</span>.<span style=color:#a6e22e>Float</span>()
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ifV</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>[<span style=color:#ae81ff>1</span>:] {
			<span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>ifV</span>)
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>CanFloat</span>() {
				<span style=color:#a6e22e>intV</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Float</span>()
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>intV</span> &gt; <span style=color:#a6e22e>max</span> {
					<span style=color:#a6e22e>max</span> = <span style=color:#a6e22e>intV</span>
				}
			}
		}
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>max</span>, <span style=color:#66d9ef>nil</span>
	}

	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unsupported element type of given slice: %T&#34;</span>, <span style=color:#a6e22e>s</span>[<span style=color:#ae81ff>0</span>])
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>m1</span>, <span style=color:#a6e22e>err1</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MaxNumber</span>([]<span style=color:#66d9ef>interface</span>{}{<span style=color:#ae81ff>4</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>15</span>})       <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>m2</span>, <span style=color:#a6e22e>err2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MaxNumber</span>([]<span style=color:#66d9ef>interface</span>{}{<span style=color:#ae81ff>4.1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>8.1</span>, <span style=color:#ae81ff>15.1</span>}) <span style=color:#75715e>// HL
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err1</span>, <span style=color:#a6e22e>err2</span>)                               <span style=color:#75715e>// &lt;nil&gt; &lt;nil&gt;
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>m1</span>, <span style=color:#a6e22e>m2</span>)                                   <span style=color:#75715e>// 15 15.1
</span><span style=color:#75715e></span>}
</code></pre></div><ul>
<li>可读性可能不太好，因为用到了复杂的反射技术。</li>
<li>会导致运行时性能差。运行时反射要比直接的代码多了很多指令操作，所以性能要慢很多。</li>
<li>失去了编译器的类型安全保障。</li>
</ul>
<h3 id=接口>接口<a href=#接口 class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>SOLID设计模式中的依赖倒置原则（Dependency Inversion Principle）要求软件接口在设计中应该依赖抽象而不是具体。</p>
<ul>
<li>可能需要定义很多数据类型。</li>
</ul>
<h1 id=实现泛型>实现泛型<a href=#实现泛型 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<p>通常意义下的泛型也叫参数多态，指的是声明与定义函数、复合类型、变量时不指定其具体的类型，而把这部分类型作为参数使用，使得该定义对各种具体类型都适用。参数化多态使得语言更具表达力，同时保持了完全的静态类型安全。这被称为泛化函数、泛化数据类型、泛型变量，形成了泛型编程的基础。</p>
<blockquote>
<p>编程语言理论(PLT)中多态(Polymorphism)包含三个主要方面：特设多态(Ad-hoc)，参数多态(Parametric)和子类型(Subtyping)。</p>
</blockquote>
<blockquote>
<p>Ad-hoc：也叫重载(Overloading)，允许具有相同名称的函数对不同类型执行不同的操作。例如，+运算符即可以将两个整数相加，也可以连接两个字符串。</p>
</blockquote>
<blockquote>
<p>Subtyping：也叫包容性多态(Inclusion)，是指通过基类指针和引用使用派生类的能力。</p>
</blockquote>
<p>子类型多态(Subtyping)是面向对象编程(OOP)中很重要的一个概念，它也称为运行时多态性，因为编译器在编译时不定位函数的地址，而是在运行时动态调用函数。这也称为动态派发(Dynamic Dispatch)。</p>
<p>派发目的是让程序运行时知道被执行的函数或方法所在的内存位置。派发分为：</p>
<p>静态派发(Static dispatch/early binding)：当程序在编译时可以找到执行的函数。C++默认使用的是直接派发，加上virtual修饰符可以改成虚函数表(Vtable)派发。直接派发是最快的，原因是调用指令少，还可通过编译器进行内联等方式的优化。这种派发缺点是不灵活，无法实现一些面向对象所需的技术如多态性。
动态派发(dynamic dispatch/run-time dispatch/virtual method call/late binding)：当程序在运行时可以找到执行的函数。Java默认使用的是虚函数表(Vtable)派发，通过final修饰符可改成直接派发。虚函数表派发是有动态性的，一个类里会用表来存储类成员函数的指针，子类重写(Override)父类的函数会替代父类的函数，子类添加的函数会被加到这个表里。当程序运行时派发时会从这个表中找到对应的函数，这样就可以实现动态派发。面向对象的编程语言正是靠此机制实现了多态性(Polymorphic)。
消息机制(message passing)：通过消息传递来调用被执行的函数。这种机制是在运行时可以改变函数的行为，甚至函数可以未实现，也不会引发运行时错误。比如Objective-C中就是通过消息传递来调用被执行的函数，甚至可以在程序运行过程中实现热更新代码。
以上三种派发方式都有其优劣：比如静态派发的速度是最快的，但并不灵活。而动态派发虽然比较慢，但却可以实现面向对象多态的功能。消息机制是最灵活的方式，但性能也最差。</p>
<h2 id=类型擦除>类型擦除<a href=#类型擦除 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h2 id=虚函数表>虚函数表<a href=#虚函数表 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h2 id=字典>字典<a href=#字典 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h2 id=单态化>单态化<a href=#单态化 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h2 id=模版>模版<a href=#模版 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h2 id=蜡印>蜡印<a href=#蜡印 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h1 id=总结>总结<a href=#总结 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://xujiajiadexiaokeai.github.io/2022-10-20/what-is-mtls/>
<span class=button__icon>←</span>
<span class=button__text>什么是mTLS</span>
</a>
</span>
<span class="button next">
<a href=https://xujiajiadexiaokeai.github.io/2022-09-21/consistent-hashing/>
<span class=button__text>Chaos Mesh上手</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>© 2021-2022 xujiajiadexiaokeai</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://xujiajiadexiaokeai.github.io/assets/main.js></script>
<script src=https://xujiajiadexiaokeai.github.io/assets/prism.js></script>
</div>
</body>
</html>