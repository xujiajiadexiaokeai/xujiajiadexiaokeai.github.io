<!doctype html><html lang=en>
<head>
<title>Dynamo :: xujiajiadexiaokeai</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Dynamo">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://xujiajiadexiaokeai.github.io/2021-10-26/dynamo/>
<link rel=stylesheet href=https://xujiajiadexiaokeai.github.io/assets/style.css>
<link rel=apple-touch-icon href=https://xujiajiadexiaokeai.github.io/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://xujiajiadexiaokeai.github.io/favicon.ico>
<meta name=twitter:card content="summary">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Dynamo">
<meta property="og:description" content="Dynamo">
<meta property="og:url" content="https://xujiajiadexiaokeai.github.io/2021-10-26/dynamo/">
<meta property="og:site_name" content="xujiajiadexiaokeai">
<meta property="og:image" content="https://xujiajiadexiaokeai.github.io/favicon.ico">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2021-10-26 13:52:30 +0800 +0800">
</head>
<body class=orange>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
RTSC && RTFM
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://xujiajiadexiaokeai.github.io/2021-10-26/dynamo/>Dynamo</a></h1>
<div class=post-meta>
<span class=post-date>
2021-10-26
</span>
<span class=post-author>:: Wenhao Jiang</span>
<span class=post-reading-time>:: 1 min read (122 words)</span>
</div>
<span class=post-tags>
#<a href=https://xujiajiadexiaokeai.github.io/tags/distributed-system/>distributed-system</a>&nbsp;
</span>
<div class=post-content><div>
<p>Dynamo is a peer-to-peer system can quickly find the key by DHT(distributed hash table)</p>
<p>为了保证能最快速的定位到key，所以在每个node中都保存了整个集群的信息，在客户端也保存了集群信息，可以将请求直接打到目标node</p>
<p>zero-hop (零跳)</p>
<h1 id=一致性哈希的优点>一致性哈希的优点：<a href=#一致性哈希的优点 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<p>node join or exit，only effect the adjacent nodes in the same hash ring</p>
<p>接着考虑到每个node的Heterogeneous(异构性)、处理能力不同，于是加入了virtual nodes（虚拟结点）的概念</p>
<p>尽量做到每个虚拟节点的处理能力一致</p>
<p>起初一致性哈希是为了解决新加入节点和退出节点对数据的影响最小，但是由于数据分布的不均匀，热点数据，节点能力的异构都会造成分布不均匀，于是加入的virtual nodes，但是为了同一份数据的replicas分布在不同的物理机器上，配置virtual也会造成一定的困难。</p>
<h1 id=一致性和复制>一致性和复制<a href=#一致性和复制 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<h2 id=replicate>replicate：<a href=#replicate class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>the node that performs data replication is called coordinator</p>
<p>负责存储key的node被称为preference list</p>
<h2 id=coordinator>coordinator<a href=#coordinator class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>coordinator进行复制的时候，是异步进行的，（可尽快给用户返回），所以Dynamo是一个弱一致系统</p>
<h2 id=nrw>NRW:<a href=#nrw class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>可自定义R和W的数量，但要满足 R + W > N</p>
<h3 id=wwn>W(W&lt;=N):<a href=#wwn class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>一个写操作只有成功更新了W个副本，才会被任务操作成功</p>
<h3 id=rrn>R(R&lt;=N):<a href=#rrn class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>一个读操作需要读的副本数量</p>
<h3 id=r--w--n>R + W > N<a href=#r--w--n class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>能够保证读操作和写操作有节点交集：至少有一个节点会被读操作和写操作同时操作到</p>
<p>通过调整R和W能实现available和consistency之间的转换</p>
<h3 id=w小r大>W小R大<a href=#w小r大 class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>writes never fail -> high availability</p>
<h3 id=r小w大>R小W大<a href=#r小w大 class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>block for all replicas to be readable -> strong consistency</p>
<p>每个node都记录自己的操作记录，通过向量时钟能够记录同一对象不同版本间的因果关系</p>
<p>当节点接收到更新 -> 逐相对比本地向量钟和待更新数据的向量钟</p>
<p>如果待更新向量钟的每一项都不小于本地向量钟，那么数据无冲突，新的值可以接受。</p>
<p>Dynamo并不会贸然假定数据的冲突合并准则，而是保留全部的冲突数据，等待客户端处理。</p>
<h1 id=容错>容错<a href=#容错 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<p>Dynamo将异常分为两种：</p>
<ul>
<li>
<p>临时性</p>
</li>
<li>
<p>永久性</p>
</li>
</ul>
<h2 id=临时性故障>临时性故障：<a href=#临时性故障 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>针对临时性故障，其处理策略就是仲裁(quorum)，但是如果严格执行仲裁策略，会影响Dynamo的可用性，因为需要等到N个节点都执行了，才能返回，此时如果其中一个结点故障了，会影响可用性。</p>
<p>于是Dynamo采用了Sloppy Quorum策略，只需要N个healthy node即可</p>
<p>Sloppy Quorum：</p>
<p>如果某台机器故障了，则顺延将数据写入到后面的健康机器，并标注数据为hinted handoff，当机器恢复后，将数据进行回传</p>
<h2 id=永久性故障>永久性故障：<a href=#永久性故障 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>针对永久性故障，其处理策略是Merkle Hash Tree.</p>
<h3 id=merkle-hash-tree>Merkle Hash Tree:<a href=#merkle-hash-tree class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>非叶子结点对应多个文件，值是其所有子节点值结合以后的哈希值；</p>
<p>叶子节点对应单个数据文件，值是文件内容的哈希</p>
<p>通过对比Merkle树，就能找出不同的文件了</p>
<h1 id=成员资格及错误检测>成员资格及错误检测<a href=#成员资格及错误检测 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<p>所有的node中都保存了集群中所有node的路由信息，这导致了有新节点加入或者节点退出的时候，需要将这消息传递给集群内的所有人，使用了gossip协议</p>
<h1 id=总体特点>总体特点<a href=#总体特点 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<ul>
<li>
<p>最终一致性</p>
</li>
<li>
<p>即使故障也保障可写</p>
</li>
<li>
<p>允许写冲突，由上层应用自行解决</p>
</li>
</ul>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://xujiajiadexiaokeai.github.io/2021-10-28/progress-in-etcd/>
<span class=button__icon>←</span>
<span class=button__text>[译]Progress in etcd</span>
</a>
</span>
<span class="button next">
<a href=https://xujiajiadexiaokeai.github.io/2021-10-16/linux-network-notes/>
<span class=button__text>Linux Network Notes</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>© 2021-2022 xujiajiadexiaokeai</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://xujiajiadexiaokeai.github.io/assets/main.js></script>
<script src=https://xujiajiadexiaokeai.github.io/assets/prism.js></script>
<script src=https://xujiajiadexiaokeai.github.io/assets/displayInlineEquations.js></script>
</div>
</body>
</html>