<!doctype html><html lang=en>
<head>
<title>[译]Progress in etcd :: xujiajiadexiaokeai</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Progress in etcd">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://xujiajiadexiaokeai.github.io/2021-10-28/progress-in-etcd/>
<link rel=stylesheet href=https://xujiajiadexiaokeai.github.io/assets/style.css>
<link rel=apple-touch-icon href=https://xujiajiadexiaokeai.github.io/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://xujiajiadexiaokeai.github.io/favicon.ico>
<meta name=twitter:card content="summary">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="[译]Progress in etcd">
<meta property="og:description" content="Progress in etcd">
<meta property="og:url" content="https://xujiajiadexiaokeai.github.io/2021-10-28/progress-in-etcd/">
<meta property="og:site_name" content="xujiajiadexiaokeai">
<meta property="og:image" content="https://xujiajiadexiaokeai.github.io/favicon.ico">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2021-10-28 15:00:30 +0800 +0800">
</head>
<body class=orange>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
RTSC && RTFM
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://xujiajiadexiaokeai.github.io/2021-10-28/progress-in-etcd/>[译]Progress in etcd</a></h1>
<div class=post-meta>
<span class=post-date>
2021-10-28
</span>
<span class=post-author>:: Wenhao Jiang</span>
<span class=post-reading-time>:: 1 min read (179 words)</span>
</div>
<span class=post-tags>
#<a href=https://xujiajiadexiaokeai.github.io/tags/etcd/>etcd</a>&nbsp;
#<a href=https://xujiajiadexiaokeai.github.io/tags/distributed-system/>distributed-system</a>&nbsp;
</span>
<div class=post-content><div>
<blockquote>
<p>From etcd Raft Design Doc</p>
</blockquote>
<p>Progress是etcd中leader保存的所有follower的progress的视图</p>
<p>Leader维护着所有follower的progress，并根据follower的progress向follower发送 <code>replication message</code></p>
<p><code>replication message</code> 是带着log entries信息的<code>msgAppend</code> 消息</p>
<p>progress有两个属性： <code>match</code> 和 <code>next</code></p>
<p><code>match</code> 是leader对该follower已确定日志(entry)中最高的index，如果leader对这个follower的日志复制情况(replication status)一无所知，<code>match</code> 则会被设置为0</p>
<p><code>next</code> 是leader将要发送给该follower的第一条日志(entry)的index,leader会将从<code>next</code> 开始到最新的entries放到下一条<code>replication message</code> 中</p>
<p>一个follower的progress会处于以下三种状态： <code>probe</code> , <code>replicate</code> ,<code>snapshot</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>                            +--------------------------------------------------------+          
                            |                  send snapshot                         |          
                            |                                                        |          
                  +---------+----------+                                  +----------v---------+
              +---&gt;       probe        |                                  |      snapshot      |
              |   |  max inflight = 1  &lt;----------------------------------+  max inflight = 0  |
              |   +---------+----------+                                  +--------------------+
              |             |            1. snapshot success                                    
              |             |               (next=snapshot.index + 1)                           
              |             |            2. snapshot failure                                    
              |             |               (no change)                                         
              |             |            3. receives msgAppResp(rej=false&amp;&amp;index&gt;lastsnap.index)
              |             |               (match=m.index,next=match+1)                        
receives msgAppResp(rej=true)                                                                   
(next=match+1)|             |                                                                   
              |             |                                                                   
              |             |                                                                   
              |             |   receives msgAppResp(rej=false&amp;&amp;index&gt;match)                     
              |             |   (match=m.index,next=match+1)                                    
              |             |                                                                   
              |             |                                                                   
              |             |                                                                   
              |   +---------v----------+                                                        
              |   |     replicate      |                                                        
              +---+  max inflight = n  |                                                        
                  +--------------------+                                                        

</code></pre></div><p><code>probe</code> ：当follower处于待调查(probe)状态时，leader在一次心跳间隔(heartbeat interval)内最多向该follower发送一条<code>replication message</code> 。leader慢慢向follower发送<code>replication message</code> 并试探follower的实际复制进展(actual progress)。leader在收到<code>msgHeartbeatResp</code> 或者<code>msgAppResp</code> 的拒绝消息后会触发下一条<code>replication message</code> 的发送。</p>
<p><code>replicate</code> ：当follower处于复制(replicate)状态时，leader在向该follower发送<code>replication message</code> 时，会乐观地(optimistically)将<code>next</code> 增加至最新的index。这是一个最优的状态(optimized state)，可以快速的将日志(log entries)复制给follower。</p>
<p><code>snapshot</code> ：当follower处于快照(snapshot)状态时，leader会停止向该follower发送<code>replication message</code></p>
<h1 id=状态流转>状态流转<a href=#状态流转 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<p>一个新选出的leader，会将所有follower的state设置为<code>probe</code> 状态，<code>match</code> 设置为0，<code>next</code> 设置为自己最新的index。之后leader会缓慢的向各个follower发送<code>replication message</code> (一次心跳最多一条)去试探他们的日志复制进展。</p>
<p>在收到follower<code>reject</code> 为<code>false</code> 的<code>msgAppResp</code> 时，会将该follower的progress设置为<code>replicate</code> 状态，这表明发送的index已经和follower目前的index匹配上了，可以进行后续日志快速的发送。当follower回复一条reject的<code>msgAppResp</code> 或者连接层(link layer) 报告follower不可连接时，该follower的progress会回到<code>probe</code> 状态。我们积极地将<code>next</code> 重置为<code>match</code> +1，因为如果我们很快收到任何<code>msgAppResp</code> ，<code>match</code> 和<code>next</code> 将直接增加到<code>msgAppResp</code> 中的index。（如果将<code>next</code> 设置过低，我们可能会发送一些重复条目。请参阅开放性问题）</p>
<p>当follower远远落后并且需要快照(snapshot)时，该follower将从<code>probe</code> 状态更改为<code>snapshot</code> 状态。发送<code>msgSnap</code> 后，leader将等待上一个快照发送成功、失败或中止。应用发送结果后，该follower的progress将返回到<code>probe</code> 状态。</p>
<h1 id=流转控制>流转控制<a href=#流转控制 class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<p>限制每条message发送的message最大大小。最大值应该是可配置的。降低探测状态的成本，因为我们限制每条消息的大小；如果下一步的罚分过低，则降低罚分</p>
<p>当处于复制状态时，限制飞行中消息的数量 &lt; N N应该是可配置的。大多数实现将在其实际网络传输层（不阻塞raft节点）的顶部有一个发送缓冲区。我们希望确保raft不会使缓冲区溢出，这可能会导致消息丢失并触发大量不必要的重复重发。</p>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://xujiajiadexiaokeai.github.io/2021-10-28/the-difference-between-http1.x-and-http2-and-http3>
<span class=button__icon>←</span>
<span class=button__text>HTTP1.x/2/3的区别</span>
</a>
</span>
<span class="button next">
<a href=https://xujiajiadexiaokeai.github.io/2021-10-26/dynamo/>
<span class=button__text>Dynamo</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>© 2021-2023 xujiajiadexiaokeai</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://xujiajiadexiaokeai.github.io/assets/main.js></script>
<script src=https://xujiajiadexiaokeai.github.io/assets/prism.js></script>
<script src=https://xujiajiadexiaokeai.github.io/assets/displayInlineEquations.js></script>
</div>
</body>
</html>